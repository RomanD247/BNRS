# Implementation Plan

- [x] 1. Установка и настройка зависимостей





  - Добавить новые зависимости в requirements.txt (pynput, psutil)
  - Создать файл конфигурации scanner_config.py с настройками сканера
  - _Requirements: 1.1, 1.2_

- [x] 2. Создание базовых классов для обработки клавиатурного ввода





  - [x] 2.1 Реализовать класс InputBuffer для накопления символов


    - Создать dataclass InputBuffer с методами add_character, clear, is_expired
    - Добавить валидацию символов и проверку таймаута
    - _Requirements: 1.3, 4.2_
  
  - [x] 2.2 Реализовать класс ScanResult для результатов сканирования


    - Создать dataclass ScanResult с полями code, success, error_message, scan_duration
    - Добавить методы для создания успешных и ошибочных результатов
    - _Requirements: 4.1, 4.4_

- [x] 3. Реализация KeyboardInputHandler





  - [x] 3.1 Создать основную структуру класса KeyboardInputHandler


    - Инициализация с использованием pynput.keyboard.Listener
    - Создание методов start_listening, stop_listening
    - _Requirements: 1.1, 2.1_
  
  - [x] 3.2 Реализовать обработчики клавиатурных событий


    - Создать методы _on_key_press и _on_key_release
    - Добавить фильтрацию специальных клавиш и накопление символов в буфере
    - Реализовать завершение ввода по символу новой строки
    - _Requirements: 1.4, 2.3_
  
  - [x] 3.3 Добавить асинхронный метод get_scanner_input


    - Создать async метод, совместимый с существующим get_nfc_input
    - Интегрировать с диалогом ожидания и обработкой ошибок
    - _Requirements: 3.1, 3.2_

- [x] 4. Реализация FocusManager





  - [x] 4.1 Создать кроссплатформенный FocusManager


    - Реализовать методы ensure_window_focus, is_window_focused, restore_focus
    - Добавить платформо-специфичную логику для Windows/Linux/macOS
    - _Requirements: 1.2, 1.5_
  
  - [x] 4.2 Интегрировать FocusManager с NiceGUI


    - Получение информации о окне приложения через NiceGUI API
    - Автоматическое восстановление фокуса при его потере
    - _Requirements: 1.5, 4.3_

- [x] 5. Создание пользовательского интерфейса сканирования





  - [x] 5.1 Реализовать класс ScannerDialog


    - Создать методы show_scanning_dialog, update_status, close_dialog
    - Интегрировать с существующими стилями диалогов NiceGUI
    - _Requirements: 2.2, 2.4_
  
  - [x] 5.2 Добавить обработку отмены сканирования


    - Реализовать кнопку отмены в диалоге сканирования
    - Корректное завершение процесса при отмене пользователем
    - _Requirements: 2.4, 4.4_

- [x] 6. Обработка ошибок и валидация





  - [x] 6.1 Создать класс ErrorHandler


    - Реализовать методы для обработки различных типов ошибок
    - Добавить понятные сообщения пользователю для каждого типа ошибки
    - _Requirements: 4.1, 4.2, 4.3, 4.4_
  
  - [x] 6.2 Добавить валидацию входных данных


    - Фильтрация вредоносных символов и ограничение длины ввода
    - Валидация формата кодов перед передачей в NFC workflow
    - _Requirements: 4.2, 4.4_

- [x] 7. Интеграция с существующей системой





  - [x] 7.1 Модифицировать NfcScan.py для использования нового сканера


    - Заменить функцию get_nfc_input на get_scanner_input
    - Сохранить все существующие интерфейсы и названия переменных
    - _Requirements: 3.1, 3.2, 3.3_
  
  - [x] 7.2 Обновить nfc_equipment_rental_workflow


    - Интегрировать новую систему сканирования с существующим workflow
    - Обеспечить совместимость с существующими диалогами подтверждения
    - _Requirements: 3.3, 3.4_

- [ ] 8. Тестирование и отладка
  - [ ]* 8.1 Создать unit тесты для основных компонентов
    - Написать тесты для KeyboardInputHandler, FocusManager, ScannerDialog
    - Добавить тесты для обработки ошибок и валидации
    - _Requirements: 1.1, 2.1, 4.1_
  
  - [ ]* 8.2 Создать integration тесты
    - Тестирование полного процесса сканирования end-to-end
    - Проверка интеграции с существующим NFC workflow
    - _Requirements: 3.1, 3.2, 3.3_

- [x] 9. Финальная интеграция и оптимизация





  - [x] 9.1 Оптимизировать производительность


    - Минимизировать потребление ресурсов при ожидании ввода
    - Оптимизировать частоту проверки фокуса и очистку буферов
    - _Requirements: 1.1, 1.2_
  
  - [x] 9.2 Добавить конфигурационные опции


    - Создать возможность настройки таймаутов и поведения сканера
    - Добавить опцию переключения между старой и новой системой
    - _Requirements: 4.1, 4.2_